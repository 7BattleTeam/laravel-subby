<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Plan Subscription Schedule | Laravel Subby</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Laravel Subby is a flexible plans and subscription management system for Laravel.">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/laravel-subby/assets/css/0.styles.a5e35d5d.css" as="style"><link rel="preload" href="/laravel-subby/assets/js/app.44d2a975.js" as="script"><link rel="preload" href="/laravel-subby/assets/js/2.a4b534a0.js" as="script"><link rel="preload" href="/laravel-subby/assets/js/13.8bfce408.js" as="script"><link rel="prefetch" href="/laravel-subby/assets/js/10.b1fc92c4.js"><link rel="prefetch" href="/laravel-subby/assets/js/11.b984a28e.js"><link rel="prefetch" href="/laravel-subby/assets/js/12.c5763095.js"><link rel="prefetch" href="/laravel-subby/assets/js/14.720c1402.js"><link rel="prefetch" href="/laravel-subby/assets/js/15.891f4aff.js"><link rel="prefetch" href="/laravel-subby/assets/js/16.a03c9f5f.js"><link rel="prefetch" href="/laravel-subby/assets/js/17.efe51d45.js"><link rel="prefetch" href="/laravel-subby/assets/js/18.729d04c2.js"><link rel="prefetch" href="/laravel-subby/assets/js/19.f2689a29.js"><link rel="prefetch" href="/laravel-subby/assets/js/20.019318dd.js"><link rel="prefetch" href="/laravel-subby/assets/js/21.29a4d5b3.js"><link rel="prefetch" href="/laravel-subby/assets/js/22.f0308ea7.js"><link rel="prefetch" href="/laravel-subby/assets/js/23.1aebc2ec.js"><link rel="prefetch" href="/laravel-subby/assets/js/24.8adaa360.js"><link rel="prefetch" href="/laravel-subby/assets/js/25.c686633a.js"><link rel="prefetch" href="/laravel-subby/assets/js/26.560f1af7.js"><link rel="prefetch" href="/laravel-subby/assets/js/27.791b1ee4.js"><link rel="prefetch" href="/laravel-subby/assets/js/28.fbc99285.js"><link rel="prefetch" href="/laravel-subby/assets/js/29.d6a5e575.js"><link rel="prefetch" href="/laravel-subby/assets/js/3.888caee7.js"><link rel="prefetch" href="/laravel-subby/assets/js/30.5e41982a.js"><link rel="prefetch" href="/laravel-subby/assets/js/31.064f0f3f.js"><link rel="prefetch" href="/laravel-subby/assets/js/32.2f011946.js"><link rel="prefetch" href="/laravel-subby/assets/js/33.47f12b0c.js"><link rel="prefetch" href="/laravel-subby/assets/js/34.49fb09d8.js"><link rel="prefetch" href="/laravel-subby/assets/js/35.0378f28e.js"><link rel="prefetch" href="/laravel-subby/assets/js/36.f92222f0.js"><link rel="prefetch" href="/laravel-subby/assets/js/37.864697b0.js"><link rel="prefetch" href="/laravel-subby/assets/js/38.344920dd.js"><link rel="prefetch" href="/laravel-subby/assets/js/39.87a3f924.js"><link rel="prefetch" href="/laravel-subby/assets/js/4.eb6494e0.js"><link rel="prefetch" href="/laravel-subby/assets/js/40.4aabf722.js"><link rel="prefetch" href="/laravel-subby/assets/js/41.0736ade8.js"><link rel="prefetch" href="/laravel-subby/assets/js/42.70c07ba7.js"><link rel="prefetch" href="/laravel-subby/assets/js/43.8edf7eb1.js"><link rel="prefetch" href="/laravel-subby/assets/js/44.ec5043a5.js"><link rel="prefetch" href="/laravel-subby/assets/js/45.f8f277e1.js"><link rel="prefetch" href="/laravel-subby/assets/js/46.638a484c.js"><link rel="prefetch" href="/laravel-subby/assets/js/47.cf857351.js"><link rel="prefetch" href="/laravel-subby/assets/js/48.3fa81892.js"><link rel="prefetch" href="/laravel-subby/assets/js/49.4c0dc239.js"><link rel="prefetch" href="/laravel-subby/assets/js/5.d0103934.js"><link rel="prefetch" href="/laravel-subby/assets/js/50.a7de39e2.js"><link rel="prefetch" href="/laravel-subby/assets/js/6.0f54e39b.js"><link rel="prefetch" href="/laravel-subby/assets/js/7.b8c14d16.js"><link rel="prefetch" href="/laravel-subby/assets/js/8.95d5e14d.js"><link rel="prefetch" href="/laravel-subby/assets/js/9.38182e4c.js">
    <link rel="stylesheet" href="/laravel-subby/assets/css/0.styles.a5e35d5d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/laravel-subby/" class="home-link router-link-active"><!----> <span class="site-name">Laravel Subby</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/laravel-subby/" class="nav-link">
  Home
</a></div> <a href="https://github.com/bpuig/laravel-subby" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/laravel-subby/" class="nav-link">
  Home
</a></div> <a href="https://github.com/bpuig/laravel-subby" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>The package</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/laravel-subby/v3.x/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/laravel-subby/v3.x/install/" class="sidebar-link">Installation</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Usage</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/laravel-subby/v3.x/models/" class="sidebar-link">Models</a></li><li><a href="/laravel-subby/v3.x/models/plan-model.html" class="sidebar-link">Plan Model</a></li><li><a href="/laravel-subby/v3.x/models/plan-feature-model.html" class="sidebar-link">Plan Feature Model</a></li><li><a href="/laravel-subby/v3.x/models/plan-subscription-model.html" class="sidebar-link">Plan Subscription Model</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Extras</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/laravel-subby/v3.x/extras/plan-subscription-schedule.html" aria-current="page" class="active sidebar-link">Plan Subscription Schedule</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/laravel-subby/v3.x/extras/plan-subscription-schedule.html#installation" class="sidebar-link">Installation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/laravel-subby/v3.x/extras/plan-subscription-schedule.html#previous-requirements" class="sidebar-link">Previous Requirements</a></li><li class="sidebar-sub-header"><a href="/laravel-subby/v3.x/extras/plan-subscription-schedule.html#configuration" class="sidebar-link">Configuration</a></li><li class="sidebar-sub-header"><a href="/laravel-subby/v3.x/extras/plan-subscription-schedule.html#migrations" class="sidebar-link">Migrations</a></li><li class="sidebar-sub-header"><a href="/laravel-subby/v3.x/extras/plan-subscription-schedule.html#extend-plan-subscription-model" class="sidebar-link">Extend Plan Subscription Model</a></li></ul></li><li class="sidebar-sub-header"><a href="/laravel-subby/v3.x/extras/plan-subscription-schedule.html#what-it-does" class="sidebar-link">What it does</a></li><li class="sidebar-sub-header"><a href="/laravel-subby/v3.x/extras/plan-subscription-schedule.html#usage" class="sidebar-link">Usage</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/laravel-subby/v3.x/extras/plan-subscription-schedule.html#create-schedule" class="sidebar-link">Create schedule</a></li><li class="sidebar-sub-header"><a href="/laravel-subby/v3.x/extras/plan-subscription-schedule.html#schedules-per-subscription" class="sidebar-link">Schedules per subscription</a></li></ul></li><li class="sidebar-sub-header"><a href="/laravel-subby/v3.x/extras/plan-subscription-schedule.html#scopes" class="sidebar-link">Scopes</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/laravel-subby/v3.x/extras/plan-subscription-schedule.html#pending" class="sidebar-link">Pending</a></li></ul></li><li class="sidebar-sub-header"><a href="/laravel-subby/v3.x/extras/plan-subscription-schedule.html#services" class="sidebar-link">Services</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/laravel-subby/v3.x/extras/plan-subscription-schedule.html#how-to-make-a-service" class="sidebar-link">How to make a service?</a></li></ul></li><li class="sidebar-sub-header"><a href="/laravel-subby/v3.x/extras/plan-subscription-schedule.html#jobs" class="sidebar-link">Jobs</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="plan-subscription-schedule"><a href="#plan-subscription-schedule" class="header-anchor">#</a> Plan Subscription Schedule</h1> <p>Want to change a subscription but not right now? Schedule it at the end of the period? With this optional extra feature
you can schedule your subscription plan changes.</p> <h2 id="installation"><a href="#installation" class="header-anchor">#</a> Installation</h2> <p>Installation is simple, follow this steps:</p> <h3 id="previous-requirements"><a href="#previous-requirements" class="header-anchor">#</a> Previous Requirements</h3> <p>This extra uses Laravel 8 batch processing. If you do not use the Jobs included in the package and make your own
processing jobs you do not need batch processing tables. If you intend to use package jobs refer
to <a href="https://laravel.com/docs/8.x/queues#job-batching" target="_blank" rel="noopener noreferrer">Queues: Job batching<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> in Laravel's official documentation.</p> <h3 id="configuration"><a href="#configuration" class="header-anchor">#</a> Configuration</h3> <h4 id="upgrading-from-0-1-x"><a href="#upgrading-from-0-1-x" class="header-anchor">#</a> Upgrading from 0.1.x</h4> <p>Versions lower than <code>0.2.0</code> do not include this part in config. If you installed this package after version <code>0.2.0</code>you
can skip this step.</p> <p>In config file <code>subby.php</code> include after <code>models</code> array:</p> <div class="language-php extra-class"><pre class="language-php"><code>
<span class="token comment">// Plan schedule settings (Optional if you do not use IsScheduled trait)</span>
<span class="token string single-quoted-string">'schedule'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'schedules_per_subscription'</span> <span class="token operator">=&gt;</span> <span class="token constant">null</span><span class="token punctuation">,</span> <span class="token comment">// Maximum number of schedules allowed for a subscription (null for no limit)</span>
    <span class="token string single-quoted-string">'tables'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'plan_subscription_schedules'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'plan_subscription_schedules'</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'models'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'plan_subscription_schedule'</span> <span class="token operator">=&gt;</span> <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>Bpuig<span class="token punctuation">\</span>Subby<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>PlanSubscriptionSchedule</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string single-quoted-string">'services'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'default'</span> <span class="token operator">=&gt;</span> <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>Bpuig<span class="token punctuation">\</span>Subby<span class="token punctuation">\</span>Services<span class="token punctuation">\</span>PlanSubscriptionSchedule<span class="token punctuation">\</span>DefaultScheduleService</span><span class="token operator">::</span><span class="token keyword">class</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">]</span>
</code></pre></div><h4 id="upgrading-from-0-2-x"><a href="#upgrading-from-0-2-x" class="header-anchor">#</a> Upgrading from 0.2.x</h4> <p>Versions lower than <code>0.3.0</code> do not include <code>schedules_per_subscription</code> in config. Default behaviour is not breaking.
You can set it to <code>null</code> to continue with functionality as it was in <code>0.2.0</code>.</p> <h3 id="migrations"><a href="#migrations" class="header-anchor">#</a> Migrations</h3> <p>Publish specific migrations for this extra:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>php artisan vendor:publish --tag<span class="token operator">=</span>subby.migrations.plan-subscription-schedule
</code></pre></div><p>Migrate:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>php artisan migrate
</code></pre></div><h3 id="extend-plan-subscription-model"><a href="#extend-plan-subscription-model" class="header-anchor">#</a> Extend Plan Subscription Model</h3> <p>Since this extra is activated by a trait in your <code>PlanSubscription</code> model, you need to extend it.</p> <div class="language-shell extra-class"><pre class="language-shell"><code>php artisan make:model PlanSubscription
</code></pre></div><p>Then edit it to extend package model and add <code>IsScheduled</code> trait.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Models</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Bpuig<span class="token punctuation">\</span>Subby<span class="token punctuation">\</span>Traits<span class="token punctuation">\</span>PlanSubscriptionSchedule<span class="token punctuation">\</span>IsScheduled</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">PlanSubscription</span> <span class="token keyword">extends</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Bpuig<span class="token punctuation">\</span>Subby<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>PlanSubscription</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token package">IsScheduled</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</span></code></pre></div><p>In your <code>subby</code> config file locate and change used model with the model you extended in previous step:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// Models</span>
<span class="token string single-quoted-string">'models'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
    <span class="token operator">...</span>
    <span class="token string single-quoted-string">'plan_subscription'</span> <span class="token operator">=&gt;</span> <span class="token class-name class-name-fully-qualified static-context"><span class="token punctuation">\</span>App<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>PlanSubscription</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>
<span class="token punctuation">]</span>
</code></pre></div><p>That is it, now you are capable of scheduling subscription plan changes.</p> <h2 id="what-it-does"><a href="#what-it-does" class="header-anchor">#</a> What it does</h2> <ul><li>Plan Subscription is scheduled to change to another plan at a certain date in the future.
<ul><li>In this schedule you specify date and which service will be executed before the change.</li> <li>You can also set a timeout and tries for the job.</li></ul></li> <li>A job is added in your app schedule</li> <li>When the time comes, job batches all pending schedules and dispatches it.
<ul><li>Job will execute your defined service before plan change, if it succeeds, change will be done. If it fails,
schedule will be flagged as failed.</li></ul></li></ul> <h2 id="usage"><a href="#usage" class="header-anchor">#</a> Usage</h2> <h3 id="create-schedule"><a href="#create-schedule" class="header-anchor">#</a> Create schedule</h3> <p>You can schedule a change in your user subscription like this:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$date</span> <span class="token operator">=</span> <span class="token class-name static-context">Carbon</span><span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'day'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">subscription</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'main'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">toPlan</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">testPlanPro</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">onDate</span><span class="token punctuation">(</span><span class="token variable">$date</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setSchedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>You can set other options like:</p> <ul><li><code>service()</code>: References <a href="#services">service</a> name in config file.</li> <li><code>timeout()</code>: Timeout for the job that will launch the service.</li> <li><code>tries()</code>: Number of tries job will be attempted</li></ul> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$date</span> <span class="token operator">=</span> <span class="token class-name static-context">Carbon</span><span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'day'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">subscription</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'main'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">toPlan</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">testPlanPro</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">onDate</span><span class="token punctuation">(</span><span class="token variable">$date</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'default'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">tries</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">timeout</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setSchedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="schedules-per-subscription"><a href="#schedules-per-subscription" class="header-anchor">#</a> Schedules per subscription</h3> <p>As introduced in <code>0.3.0</code>, you can now set a limit of schedules per subscription in your config.</p> <p>You can check if subscription has reached its limit on your subscription object
with <code>$subscription-&gt;reachedScheduleLimit()</code>.</p> <p>You can also dynamically ignore the schedule limit with <code>ignoreLimit(true|false)</code> (defaults to <code>true</code>):</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">subscription</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'main'</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">toPlan</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">testPlanPro</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">onDate</span><span class="token punctuation">(</span><span class="token variable">$date</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">ignoreLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">setSchedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="scopes"><a href="#scopes" class="header-anchor">#</a> Scopes</h2> <p>This are the scopes you can apply to your <code>PlanSubscriptionSchedule</code> model.</p> <p><code>notProcessed()</code> returns all unprocessed schedules (not having success or failure) in the past and in the future.</p> <h3 id="pending"><a href="#pending" class="header-anchor">#</a> Pending</h3> <p><code>pending()</code> returns a list of schedules that have not been processed and are due to be processed. To define an ending
date, use <code>Carbon</code> date as parameter to show pending until specified date. Default returns pending until now.</p> <h2 id="services"><a href="#services" class="header-anchor">#</a> Services</h2> <p>By default, the config file includes a <code>default</code> service for processing your plan change. This service it's a good
starting point to see how it works. The default service is an empty service that will not perform any action or stop the
plan change.</p> <h3 id="how-to-make-a-service"><a href="#how-to-make-a-service" class="header-anchor">#</a> How to make a service?</h3> <p>In the example <code>DefaultScheduleService</code> you can see the minimum requirements of a service.</p> <p>Your own service has to implement interface <code>PlanSubscriptionScheduleService</code> and also use <code>IsScheduleService</code>
trait. <code>__construct</code> accepts one parameter, the <code>PlanSubscriptionSchedule</code> Eloquent object of the subscription schedule.</p> <p>The outcome to later change plan or not is defined by <code>success</code> property. By default is <code>false</code>, so your successful
process has to set it to <code>true</code>. Any exception will stop the process.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>


<span class="token keyword">namespace</span> <span class="token package">Bpuig<span class="token punctuation">\</span>Subby<span class="token punctuation">\</span>Services<span class="token punctuation">\</span>PlanSubscriptionSchedule</span><span class="token punctuation">;</span>


<span class="token keyword">use</span> <span class="token package">Bpuig<span class="token punctuation">\</span>Subby<span class="token punctuation">\</span>Contracts<span class="token punctuation">\</span>PlanSubscriptionScheduleService</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Bpuig<span class="token punctuation">\</span>Subby<span class="token punctuation">\</span>Traits<span class="token punctuation">\</span>PlanSubscriptionSchedule<span class="token punctuation">\</span>IsScheduleService</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">DefaultScheduleService</span> <span class="token keyword">implements</span> <span class="token class-name">PlanSubscriptionScheduleService</span>
<span class="token punctuation">{</span>

    <span class="token keyword">use</span> <span class="token package">IsScheduleService</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * DefaultScheduleService constructor.
     * Save current Plan Subscription Schedule
     * @param $planSubscriptionSchedule
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$planSubscriptionSchedule</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">planSubscriptionSchedule</span> <span class="token operator">=</span> <span class="token variable">$planSubscriptionSchedule</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Execute the strategy
     *
     * Since this is kind of a dummy process, set success to true
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">success</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">clearUsage</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre></div><h2 id="jobs"><a href="#jobs" class="header-anchor">#</a> Jobs</h2> <p>To process the schedules you need to include the <code>SubscriptionScheduleQueuerJob</code> in your app schedule.</p> <p>I recommend setting it without overlapping, since package allows to schedule multiple plan changes for the same
subscription. In <code>app/Console/Kernel.php</code>:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">schedule</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Schedule</span> <span class="token variable">$schedule</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token operator">...</span>
        <span class="token variable">$schedule</span><span class="token operator">-&gt;</span><span class="token function">job</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SubscriptionScheduleQueuerJob</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">everyFiveMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">withoutOverlapping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>This job will make a batch of jobs for pending subscription changes.</p> <p>I recommend running first this job with a date parameter and then chain your regular subscription renewal job with said
date parameter as end to avoid collision since a subscription can have same <code>ends_at</code> and <code>scheduled_at</code> dates. This
order of events would prevent renewals before schedules, since after schedule is processed <code>ends_at</code> would have changed
to next period.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/20/2021, 4:40:01 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/laravel-subby/v3.x/models/plan-subscription-model.html" class="prev">
        Plan Subscription Model
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/laravel-subby/assets/js/app.44d2a975.js" defer></script><script src="/laravel-subby/assets/js/2.a4b534a0.js" defer></script><script src="/laravel-subby/assets/js/13.8bfce408.js" defer></script>
  </body>
</html>
